kind: pipeline
name: default
type: docker
steps:
- name: publish  
  image: plugins/ecr
  settings:
    access_key:
      from_secret: access_key
    secret_key:
      from_secret: secret_key
    repo: 466110168776.dkr.ecr.us-east-1.amazonaws.com/apache2
    registry: 466110168776.dkr.ecr.us-east-1.amazonaws.com
- name: ssh commands
  image: appleboy/drone-ssh
  settings:
    host: 54.209.92.141
    username: ubuntu
    key:
      from_secret: ssh-key
    port: 22
    script:
      - sudo chown ubuntu:ubuntu /var/run/docker.sock
      - sudo aws ecr get-login-password --region us-east-1 | sudo docker login --username AWS --password-stdin 466110168776.dkr.ecr.us-east-1.amazonaws.com
      - sudo docker pull 466110168776.dkr.ecr.us-east-1.amazonaws.com/apache2:latest
      - sudo docker run -dit -p 8080:80 --name apache2 466110168776.dkr.ecr.us-east-1.amazonaws.com/apache2:latest
      - ls
      
